---
output: html_document
editor_options: 
  chunk_output_type: console
---
The idea now and here is to limit the sample size to only those districts that had 0 deaths by 1998. And then, among them, classify as treatment those districts with higher than average deaths by the end of 2008. 


```{r}
setwd("/home/suhishan/Documents/Final Sem Research/Conflict/R files/")
library(haven)
library(tidyverse)
library(stargazer)
library(patchwork)
library(dagitty)
library(sf)
library(ddecompose)
library(DRDID)
library(xtable)
library(purrr)

theme_set(theme_minimal() +
            theme(panel.grid = element_blank()))

```


#Load Datasets.

```{r}
nlfs <- read_dta("appended_nlfs.dta") # Only people aged 10 and above. 

nlfs <- nlfs %>% 
  mutate(post = ifelse(nlfs_year == 2008, 1, 0)) # No Manang and Dolpa in NLFS data. 
 
c <- read_dta("final_conflict.dta")

# Renaming and mutating most of the variables that I will need.

# Select only the relevant variables. 
c <- c %>% select(
  distname, elevation_max,norm_forest, pov_rate, district_abbrev,popn_2001,
  best_est, 30:51, incidents
)

c <- c %>% mutate(
    forest_cover = round(norm_forest * 100, 2),
    poverty_rate = round(pov_rate * 100, 2),
    # note: Dolpa, Mustang and Rasuwa don't have poverty rate estimates.
    
    # Manang and Mustang (NA no conflict deaths) turned to 0 
    conflict_deaths = ifelse(is.na(best_est),
                             0, best_est),
    cd_per_10000 = (conflict_deaths / popn_2001) * 1e4,
    deaths_until_98 = deaths_96 + deaths_97 + deaths_98,
    deaths_until_97 = deaths_96 + deaths_97
    ) %>% 
  mutate(
    deaths_until_98 = ifelse(is.na(deaths_until_98), 0, deaths_until_98)
  )

```


#Let's now restrict our sample to only those districts which experienced no casualties by the end of 1998 A.D.

```{r}
c_small <- c %>% filter(deaths_until_98 == 0)

# Let's now plot the conflict casualties.

c_small %>% 
  mutate(index = 1:n()) %>% 
  ggplot(aes(x = index, y = cd_per_10000))+
  geom_point() 
 
  
# Deaths higher than the 75th percentile treatment and lower than 25th percentile control.

c_small <- c_small %>% mutate(
  p75_deaths = ifelse(cd_per_10000 > quantile(cd_per_10000, 0.75), 
                      1, 0),
  p25_deaths = ifelse(cd_per_10000 < quantile(cd_per_10000, 0.25), 
                      1, 0),
) %>% filter(
  p75_deaths == 1 | p25_deaths == 1
) %>% filter(
  # no Manang in Nlfs data so filtered it out.
  district_abbrev != "mana"
)

```

Let's now make treatment and control.

```{r}
c_small <- c_small %>% mutate(
  treatment_s = ifelse(p75_deaths == 1, 1, 0)
)

```

#First stage lm regression to see how many conflict deaths higher do treatment districts face than non conflict ones. 

```{r}
c_small <- c_small %>% 
  mutate(
    conflict_deaths_std = (conflict_deaths - mean(conflict_deaths))/
      sd(conflict_deaths),
    cd_per_10000_std = 
      rethinking::standardize(cd_per_10000)
  )

#Display the differences in a graph.
tibble(c_small, index = 1:21) %>% 
  ggplot(aes(x = index, y = cd_per_10000)) + 
  geom_point(aes(color = as.factor(treatment_s)))


#m1 <- lm(conflict_deaths ~ treatment_s, data = c_small); summary(m1)
#m2 <- lm(conflict_deaths_std ~ treatment_s, data = c_small); summary(m2)
m3 <- lm(cd_per_10000_std  ~ treatment_s, data = c_small); summary(m3)

stargazer(m3,  type = "latex", star.cutoffs = NA,
          keep.stat = c("n", "rsq","adj.rsq"),
          covariate.labels = c("Treatment (1/0)"),
          dep.var.labels = c("Conflict Deaths per 10,000 population (std)"),
          notes = "(std) represents standardized variables",
          out = "../First Draft/small_sample_reg.tex",
          title = "Conflict Deaths per 10,000 population regressed on Treatment Status",
          notes.append =F)
```


```{r}
c_merged <- left_join(c_small, nlfs, by = c("district_abbrev"))

c_merged <-  c_merged %>% mutate(
  id = as.numeric(1:n()),
  post = ifelse(nlfs_year == 2008, 1, 0),
  years_of_edu_all = ifelse(is.na(years_of_edu_all), 0, years_of_edu_all)
) %>% filter(!is.na(post) & age > 18)

c_merged_98 <- c_merged %>% filter(nlfs_year == 1998)

```


Normalized Difference.

Now calculating the normalized difference of some observable characteristics that may have impacted untreated potential outcomes trend. 

```{r}
#function to calculate normalized difference
norm_difference <- function(t, x) {
  mean_t <-  mean(x[t == 1], na.rm = T)
  mean_c <-  mean(x[t == 0], na.rm = T)
  sd_t <-  sd(x[t == 1],na.rm =T)
  sd_c <- sd(x[t==0],na.rm = T )
  norm_diff = (mean_t - mean_c) / sqrt(0.5 * (sd_t^2 + sd_c^2))
  return (round(norm_diff, digits = 4))
}


table_norm <- c_merged_98 %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize, urbrur,
         ever_school) %>% 
  summarize(across(
    .cols = -treatment_s,
    .fns = list(
      norm_diff = ~norm_difference(treatment_s, .x),
      mean_t  = ~ mean(.x[treatment_s == 1], na.rm = T),
      mean_c = ~mean(.x[treatment_s == 0], na.rm = T)),
    .names = "{fn}_{.col}"
  )) %>% 
 pivot_longer(
    cols = everything(),
    names_to = "stat_var", values_to = "value"
  ) %>% 
  extract(stat_var, into = c("stat", "variable"),
          regex = "(norm_diff|mean_t|mean_c)_(.+)") %>% 
  pivot_wider(
    names_from = stat, values_from = value
  )


```

Outputting this table into Latex:
```{r}
pretty_names <- c(
  age = "Age",
  years_of_edu_all = "Years of Education (All)",
  years_of_edu = "Years of Education (If attended school)",
  hindu = "Hindu (1/0)",
  brahmin_chhetri = "Brahmin/Chhetri(1/0)",
  sex = "Male",
  marital_status = "Married",
  hhsize = "Household Size",
  urbrur = "Urban",
  ever_school = "Ever Attended School"
)

table_norm_out <- table_norm %>% 
  mutate(
    variable = pretty_names[variable]
  ) %>% 
  rename(
    `Norm. Diff` = norm_diff,
    `Treated Mean` = mean_t,
    `Control Mean` = mean_c,
  ) %>% mutate(
    across(c(`Norm. Diff`, `Treated Mean`, `Control Mean`), ~ round(.x, 3))
  ) %>% 
  column_to_rownames("variable")

print(xtable(table_norm_out, caption = "Covariate Balance Statistics"), 
      type = "latex",
      file = "../First Draft/covariate_balance.tex",
      booktabs = T,
      )

table_norm_out


```


Delta Normalized Difference. 

Now for the covariate differences:

```{r}
d1 <- c_merged %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize,post, urbrur,
         ever_school) %>% 
  group_by(treatment_s) %>% 
  summarize(
    across(
      .cols = -post,
      .fns = list(
        delta = ~ mean(.x[post == 1], na.rm = T) - mean(.x[post == 0], 
                                                        na.rm = T)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop") %>% 
    pivot_longer(cols = -treatment_s, names_to = "variables",
                 values_to = "delta") %>% 
  pivot_wider(names_from = treatment_s, values_from = delta,
              names_prefix = "delta_")

d1

```


Output the trends as well:
```{r}
pretty_names_delta <- c(
  age_delta = "Age",
  years_of_edu_all_delta = "Years of Education (All)",
  years_of_edu_delta = "Years of Education (If attended school)",
  hindu_delta = "Hindu (1/0)",
  brahmin_chhetri_delta = "Brahmin/Chhetri(1/0)",
  sex_delta = "Male",
  marital_status_delta = "Married",
  hhsize_delta = "Household Size",
  urbrur_delta = "Urban",
  ever_school_delta = "Ever Attended School"
)

d1_out <- d1 %>% 
  mutate(variables = pretty_names_delta[variables]) %>% 
  rename(
    `Control trend` = delta_0,
    `Treatment trend` = delta_1,
  ) %>% column_to_rownames("variables") %>% 
  mutate(
    across(c(`Control trend`,`Treatment trend`), ~ round(.x, 3) )
  )


print(xtable(d1_out, caption = "Covariate Balance Statistics for trends/differences (2008 - 1998)"), 
      type = "latex",
      file = "../First Draft/covariate_balance_trends.tex",
      booktabs = T,
      )


```


Now for normalized differences (The function is wrong or incomplete)

```{r}
#This function is to calculate normalized difference in delta_X, so calculate mean difference in post/pre for both treatment and control, and also calculate the sd of the differences. 

norm_diff_delta <- function(t, post, x) {
  mean_delta_c = mean(x[t==0 & post ==1 ], na.rm =T) 
                  - mean(x[t == 0 & post == 0], na.rm = T)
  mean_delta_t = mean(x[t==1 & post ==1 ], na.rm = T) 
                  - mean(x[t == 1 & post == 0], na.rm = T)
  
  var_delta_c = var(x[t==0 & post ==1 ], na.rm = T) 
                  + var(x[t == 0 & post == 0], na.rm = T) +
                2 * cov(x[t==0 & post ==1 ], x[t==0 & post ==0 ])
  
  var_delta_c = var(x[t==0 & post ==1 ], na.rm = T) 
                  + var(x[t == 0 & post == 0], na.rm = T) +
                2 * cov(x[t==0 & post ==1 ], x[t==0 & post ==0 ])
  
  
  norm_diff = (mean_delta_t - mean_delta_c)/
    sqrt(0.5 * (var_delta_t + var_delta_c))
  
  return (round(norm_diff, 4))
}

d2 <- c_merged %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize,post,
         ever_school) %>% 
  summarize(
    across(
      .cols = -c(treatment_s, post),
      .fns = list(
        norm_diff_delta = ~ norm_diff_delta(treatment_s, post, .x)
      ),
      .names = "{.col}"
    )
  ) %>% pivot_longer(everything())

d2

table_norm_delta <- bind_cols(d2, d1) %>% 
  select(-variables) %>% 
  rename(`2008 - 1998 Covariate Differences` = name, 
         `Norm Diff` = value,
         delta_Treatment = delta_1,
         delta_Control = delta_0)

table_norm_delta

```


Let's graph the propensity scores a

# Propensity Score Model. (for Transparency)

Here, we use the pre-period 1998 data to construct a logit model where treatment status is regressed on covariates that may have influenced treatment assignment i.e. Regress treatment status on age, years of education, brahmin_chhetri and hindu for 2020.

Output propensity score of being assigned treatment into a tex file n
```{r}

library(sandwich)
library(lmtest)

c_merged_98 <- c_merged_98 %>% filter(!is.na(years_of_edu_all) &
                                        !is.na(poverty_rate))

# Mustang doesn't have poverty_rate estimates so it is selected out.

ps <- glm(treatment_s ~  age + hindu + brahmin_chhetri + 
          years_of_edu_all,
          data = c_merged_98, family = binomial(link = "logit") )

summary(ps)


cl_vcov <- vcovCL(ps, cluster = c_merged_98$psu, type = "HC1")
cl_test <- coeftest(ps, vcov. = cl_vcov); cl_test


coefs <- cl_test[, 1]
ses <- cl_test[, 2] # clustered standard errors. 

# Output to .tex file
stargazer(ps,
          se = list(ses),
          type = "latex",
          out = "../First Draft/propensity_score_reg.tex",
          title = "Propensity Score Regression on observed covariates (1998 NLFS)",
          dep.var.labels = "Treatment (high-conflict)",
          covariate.labels = c("Age", "Hindu", "Brahmin/Chhetri", "Years of Education"),
          digits = 3,
          star.cutoffs = NA,
          
          notes = "Standard errors are psu-clustered",
          notes.append = F)

```


Displaying the overlap in propensity scores for the initial model.
```{r}

c_merged_98$pscore <- predict(ps, type = "response")

ps_small_sample <- c_merged_98 %>% 
  ggplot(aes(x = pscore, color = factor(treatment_s)))+
  geom_histogram(aes(y = ..density..),alpha = 0.5,
                 position = "identity",
                 fill = "white",
                 bins = 40,
                 linewidth = 1.35)+
  scale_color_manual(values = c("blue","red"),
                     name = "Treatement",
                     labels = c("Low Conflict", "High Conflict")) +
  labs(
    x= "Propensity Score",
    y = "Density"
  )

ps_small_sample

ggsave("../First Draft/ps_sample_sample.jpg", plot = ps_small_sample,
       width = 25, height = 15, units = c("cm"), bg = "white")

```


Normal Simple DiD.

```{r}
c_merged %>% 
  group_by(nlfs_year) %>% 
  summarize(diff = mean(usually_emp[treatment_s == 1]) - 
              mean(usually_emp[treatment_s == 0])) %>% 
  summarize(.[2,2] - .[1,2]) %>% 
  pull()

did_regression <- lm(currently_emp ~ post*treatment_s, data = c_merged); summary(did_regression)
coeftest(did_regression, vcov = vcovHC(did_regression, type = "HC1"))
# Yes the standard errors match when doing robust stuff. Use IPW estimator. 

```



IPW DiD Estimate

```{r}

# Normal DiD
ipwdid(yname = "usually_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged, panel = FALSE, boot = F, nboot = 199)


# IPW DiD
ipwdid(yname = "usually_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged, panel = FALSE, boot = F, nboot = 199)

# On Currently Employed.

# Normal DiD
ipwdid(yname = "currently_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_f, panel = FALSE, boot = F, nboot = 199)


# IPW DiD
ipwdid(yname = "currently_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_f, panel = FALSE, boot = F, nboot = 199)


# On Currently Employed but outside.

ipwdid(yname = "currently_emp_out", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_f, panel = FALSE, boot = F, nboot = 199)

ipwdid(yname = "currently_emp_out", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_f, panel = FALSE, boot = F, nboot = 199)

# Work Hours.

drdid(yname = "work_hours_outside", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged, panel = FALSE, boot = F, nboot = 199)

drdid(yname = "work_hours_outside", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_f, panel = FALSE, boot = F, nboot = 199)

```


# Rural Only Sample

```{r}
c_merged_r <- c_merged %>% filter(urbrur == 0)
c_merged_98_r <- c_merged_r %>% filter(post == 0)

# Propensity Scores for rural areas. 

library(sandwich)
library(lmtest)

c_merged_98_r <- c_merged_98_r %>% filter(!is.na(years_of_edu_all) &
                                        !is.na(poverty_rate))

# Mustang doesn't have poverty_rate estimates so it is selected out.

ps <- glm(treatment_s ~  age + hindu + brahmin_chhetri + 
          years_of_edu_all,
          data = c_merged_98_r, family = binomial(link = "logit") )

summary(ps)


cl_vcov <- vcovCL(ps, cluster = c_merged_98_r$psu, type = "HC1")
cl_test <- coeftest(ps, vcov. = cl_vcov); cl_test


coefs <- cl_test[, 1]
ses <- cl_test[, 2] # clustered standard errors. 

# Output to .tex file
stargazer(ps,
          se = list(ses),
          type = "latex",
          out = "../First Draft/propensity_score_reg_rural.tex",
          title = "Propensity Score Regression on observed covariates (1998 NLFS) for the Rural only Sample",
          dep.var.labels = "Treatment (high-conflict)",
          covariate.labels = c("Age", "Hindu", "Brahmin/Chhetri", "Years of Education"),
          digits = 3,
          star.cutoffs = NA,
          
          notes = "Standard errors are psu-clustered",
          notes.append = F)



```

# Rural only Overlap Graph

```{r}
c_merged_98_r$pscore <- predict(ps, type = "response")

ps_small_sample_r <- c_merged_98_r %>% 
  ggplot(aes(x = pscore, color = factor(treatment_s)))+
  geom_histogram(aes(y = ..density..),alpha = 0.5,
                 position = "identity",
                 fill = "white",
                 bins = 40,
                 linewidth = 1.35)+
  scale_color_manual(values = c("blue","red"),
                     name = "Treatement",
                     labels = c("Low Conflict", "High Conflict")) +
  labs(
    x= "Propensity Score",
    y = "Density"
  )

ps_small_sample_r

ggsave("../First Draft/ps_sample_sample_r.jpg", plot = ps_small_sample_r, width = 25, height = 15, units = c("cm"), bg = "white")

```

# Rural Only DiD Estimates.

```{r}
# Normal DiD
ipwdid(yname = "usually_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)


# IPW DiD
ipwdid(yname = "usually_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)

# On Currently Employed.

# Normal DiD
ipwdid(yname = "currently_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)


# IPW DiD
ipwdid(yname = "currently_emp", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)


# On Currently Employed but outside.

ipwdid(yname = "currently_selfemp_out", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)

ipwdid(yname = "currently_selfemp_out", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~  age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)

# Work Hours.

drdid(yname = "selfemp_hours_outside", tname = "post", idname = "id",
      dname = "treatment_s",
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)

drdid(yname = "selfemp_hours_outside", tname = "post", idname = "id",
      dname = "treatment_s",
      xformla = ~ age + hindu + brahmin_chhetri + years_of_edu_all,
      data = c_merged_r, panel = FALSE, boot = F, nboot = 199)

```




```{r}
c_merged_u <- c_merged %>% filter(urbrur == 1)
c_merged_r <- c_merged %>% filter(urbrur == 0)


c_merged_m <- c_merged %>% filter(sex == 1)
c_merged_f <- c_merged %>% filter(sex == 0)


c_merged_r %>% group_by(treatment_s, post) %>% summarize(n())

```















Poverty Rate Differences among district.
```{r}
c_merged <- c_merged %>% 
  mutate(
    district_id = as.numeric(as.factor(district_abbrev))
  )

tibble(
  id = 1:length(c_small$poverty_rate),
  p = c_small$poverty_rate,
  t = c_small$treatment_s
) %>% 
  ggplot(aes(x = id, y = p))+
  geom_point(aes(color = as.factor(t)))

```

